(function(e,t){'object'==typeof exports&&'object'==typeof module?module.exports=t():'function'==typeof define&&define.amd?define('stush',[],t):'object'==typeof exports?exports.stush=t():e.stush=t()})(this,function(){return function(e){function t(r){if(a[r])return a[r].exports;var u=a[r]={i:r,l:!1,exports:{}};return e[r].call(u.exports,u,u.exports,t),u.l=!0,u.exports}var a={};return t.m=e,t.c=a,t.d=function(e,a,r){t.o(e,a)||Object.defineProperty(e,a,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var a=e&&e.__esModule?function(){return e['default']}:function(){return e};return t.d(a,'a',a),a},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p='',t(t.s=22)}([function(e){e.exports=require('lodash/assignIn')},function(e){e.exports=require('lodash/get')},function(e){e.exports=require('lodash/has')},function(e){e.exports=require('lodash/pick')},function(e,t,a){'use strict';Object.defineProperty(t,'__esModule',{value:!0});var r=a(16),u=function(e){return e&&e.__esModule?e:{default:e}}(r);t.default=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;return(0,u.default)(e)&&(e={message:e,code:500}),new Error({stush:e,stripe:t})}},function(e){e.exports=require('lodash/set')},function(e){e.exports=require('lodash/cloneDeep')},function(e){e.exports=require('lodash/omit')},function(e){e.exports=require('joi')},function(e){e.exports=require('lodash/unset')},function(e){e.exports=require('lodash/keys')},function(e,t,a){'use strict';function r(e){return e&&e.__esModule?e:{default:e}}function u(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,a){function r(u,l){try{var n=t[u](l),d=n.value}catch(e){return void a(e)}return n.done?void e(d):Promise.resolve(d).then(function(e){r('next',e)},function(e){r('throw',e)})}return r('next')})}}function l(e,t){if(!(e instanceof t))throw new TypeError('Cannot call a class as a function')}Object.defineProperty(t,'__esModule',{value:!0}),t.default=void 0;var n=a(12),d=r(n),s=a(2),i=r(s),o=a(0),p=r(o),f=a(6),c=r(f),v=a(9),h=r(v),b=a(1),_=r(b),m=function(){function e(e,t){for(var a,r=0;r<t.length;r++)a=t[r],a.enumerable=a.enumerable||!1,a.configurable=!0,'value'in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}return function(t,a,r){return a&&e(t.prototype,a),r&&e(t,r),t}}(),x=a(27),y=r(x),g=a(4),k=r(g),w=function(){function e(t){var a=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};l(this,e),this.data={},this._stush={},this._cache={},this._stush=t,this._cache=t.fetchCacheInstance(),this.set(a,!0)}return m(e,[{key:'set',value:function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1],a=(0,c.default)(this.data);(0,p.default)(a,e),a=(0,x.formatPlanData)(a),this.data=a}},{key:'save',value:function(){var t=u(regeneratorRuntime.mark(function t(){var a,r,u;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,a=(0,x.validator)(this.data),t.next=4,this._stush.stripe.plans.update(this.data.id,a.value);case 4:if(r=t.sent,this._cache.put(r.id,new e(this._stush,r),this._stush.fetchCacheLifetime()),this._cache.keys().includes('all_plans')){t.next=11;break}return t.next=9,e.fetchAll(this._stush);case 9:t.next=12;break;case 11:this.updateAllPlansCache(r);case 12:return this.set(r,!0),t.abrupt('return',Promise.resolve(this));case 16:if(t.prev=16,t.t0=t['catch'](0),!((0,i.default)(t.t0,'raw')&&'plan'===t.t0.raw.param&&404===t.t0.raw.statusCode)){t.next=31;break}return t.next=21,this._stush.stripe.plans.create(this.data);case 21:if(u=t.sent,this._cache.put(u.id,new e(this._stush,u),this._stush.fetchCacheLifetime()),this._cache.keys().includes('all_plans')){t.next=28;break}return t.next=26,e.fetchAll(this._stush);case 26:t.next=29;break;case 28:this.updateAllPlansCache(u);case 29:return this.set(u,!0),t.abrupt('return',Promise.resolve(this));case 31:return t.abrupt('return',Promise.reject(t.t0));case 32:case'end':return t.stop();}},t,this,[[0,16]])}));return function(){return t.apply(this,arguments)}}()},{key:'selfPopulate',value:function(){var t=u(regeneratorRuntime.mark(function t(){var a,r;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(this.data.id){t.next=2;break}return t.abrupt('return',Promise.reject((0,k.default)('Please provide a valid plan ID before self populating')));case 2:if(t.prev=2,a=void 0,r=this._cache.keys(),!r.includes(this.data.id)){t.next=9;break}a=this._cache.get(this.data.id).data,t.next=18;break;case 9:return t.next=11,this._stush.stripe.plans.retrieve(this.data.id);case 11:if(a=t.sent,this._cache.keys().includes('all_plans')){t.next=17;break}return t.next=15,e.fetchAll(this._stush);case 15:t.next=18;break;case 17:this.updateAllPlansCache(this.data);case 18:return(0,p.default)(this.data,a),t.abrupt('return',Promise.resolve(this));case 22:return t.prev=22,t.t0=t['catch'](2),t.abrupt('return',Promise.reject(t.t0));case 25:case'end':return t.stop();}},t,this,[[2,22]])}));return function(){return t.apply(this,arguments)}}()},{key:'delete',value:function(){var t=u(regeneratorRuntime.mark(function t(){var a;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,a=this.data.id,t.next=4,this._stush.stripe.plans.del(a);case 4:if(this.data=t.sent,this._cache.del(a),this._cache.keys().includes('all_plans')){t.next=11;break}return t.next=9,e.fetchAll(this._stush);case 9:t.next=12;break;case 11:this.updateAllPlansCache(a,!0);case 12:return t.abrupt('return',Promise.resolve(this));case 15:return t.prev=15,t.t0=t['catch'](0),t.abrupt('return',Promise.reject(t.t0));case 18:case'end':return t.stop();}},t,this,[[0,15]])}));return function(){return t.apply(this,arguments)}}()},{key:'toJson',value:function(){return JSON.parse(JSON.stringify((0,_.default)(this,'data')))}},{key:'getInterval',value:function(){return this.data.interval_count+' '+this.data.interval}},{key:'getPrice',value:function(){return this.data.amount}},{key:'updateAllPlansCache',value:function(t){var a,r=1<arguments.length&&void 0!==arguments[1]&&arguments[1],u=this._stush.fetchCacheInstance(),l=u.get('all_plans'),n=function(e){(0,d.default)(l,function(){return e.id===t.id})},s=!0,i=!1;try{for(var o,p,f=l[Symbol.iterator]();!(s=(o=f.next()).done);s=!0)p=o.value,n(p)}catch(e){i=!0,a=e}finally{try{!s&&f.return&&f.return()}finally{if(i)throw a}}r||l.push(new e(this._stush,t))}}],[{key:'fetchAll',value:function(){var t=u(regeneratorRuntime.mark(function t(a){var r,u,l,n,d,s,i,o,p,f,c,v=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(t.prev=0,r=a.fetchCacheInstance(),u=a.fetchCacheLifetime(),l=r.keys(),n=[],!l.includes('all_plans')||(0,_.default)(v,'refresh_cache',!1)){t.next=7;break}n=r.get('all_plans'),t.next=31;break;case 7:return(0,h.default)(v,'refresh_cache'),t.next=10,a.stripe.plans.list(v);case 10:for(d=t.sent,s=!0,i=!1,o=void 0,t.prev=14,p=d.data[Symbol.iterator]();!(s=(f=p.next()).done);s=!0)c=f.value,n.push(new e(a,c)),r.put((0,_.default)(c,'id'),new e(a,c),u);t.next=22;break;case 18:t.prev=18,t.t0=t['catch'](14),i=!0,o=t.t0;case 22:t.prev=22,t.prev=23,!s&&p.return&&p.return();case 25:if(t.prev=25,!i){t.next=28;break}throw o;case 28:return t.finish(25);case 29:return t.finish(22);case 30:r.put('all_plans',n,u);case 31:return t.abrupt('return',Promise.resolve(n));case 34:return t.prev=34,t.t1=t['catch'](0),t.abrupt('return',Promise.reject(t.t1));case 37:case'end':return t.stop();}},t,this,[[0,34],[14,18,22,30],[23,,25,29]])}));return function(){return t.apply(this,arguments)}}()}]),e}();t.default=w},function(e){e.exports=require('lodash/remove')},function(e,t,a){'use strict';function r(e){return e&&e.__esModule?e:{default:e}}function u(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,a){function r(u,l){try{var n=t[u](l),d=n.value}catch(e){return void a(e)}return n.done?void e(d):Promise.resolve(d).then(function(e){r('next',e)},function(e){r('throw',e)})}return r('next')})}}function l(e,t){if(!(e instanceof t))throw new TypeError('Cannot call a class as a function')}Object.defineProperty(t,'__esModule',{value:!0}),t.default=void 0;var n=a(3),d=r(n),s=a(2),i=r(s),o=a(0),p=r(o),f=a(6),c=r(f),v=function(){function e(e,t){for(var a,r=0;r<t.length;r++)a=t[r],a.enumerable=a.enumerable||!1,a.configurable=!0,'value'in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}return function(t,a,r){return a&&e(t.prototype,a),r&&e(t,r),t}}(),h=a(4),b=r(h),_=a(32),m=r(_),x=function(){function e(t){var a=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};l(this,e),this.data={},this._stush={},this._stush=t,this.set(a,!0)}return v(e,[{key:'set',value:function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1],a=(0,c.default)(this.data);(0,p.default)(a,e),(0,_.validator)(a,t),this.data=a}},{key:'save',value:function(){var e=u(regeneratorRuntime.mark(function e(){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,t=void 0,!(0,i.default)(this,'data.id')){e.next=5;break}e.next=8;break;case 5:return e.next=7,this._stush.stripe.invoices.create(this.data);case 7:t=e.sent;case 8:return this.set(t,!0),e.abrupt('return',Promise.resolve(this));case 12:return e.prev=12,e.t0=e['catch'](0),e.abrupt('return',Promise.reject(e.t0));case 15:case'end':return e.stop();}},e,this,[[0,12]])}));return function(){return e.apply(this,arguments)}}()},{key:'toJson',value:function(){return JSON.parse(JSON.stringify((0,d.default)(this,['data'])))}},{key:'populateWithUpcoming',value:function(){var e=u(regeneratorRuntime.mark(function e(t){var a,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if((0,i.default)(t,'customer')){e.next=2;break}return e.abrupt('return',Promise.reject((0,b.default)('Please provide a valid customer ID to add a new subscription.')));case 2:if((0,i.default)(t,'subscription')){e.next=4;break}return e.abrupt('return',Promise.reject((0,b.default)('Please provide a valid subscription to fetch upcoming invoice.')));case 4:return a=(0,_.sanitizePopulateWithUpcoming)(t),e.next=7,this._stush.stripe.invoices.retrieveUpcoming(t.customer,t.subscription,a);case 7:r=e.sent,this.set(r,!0);case 9:case'end':return e.stop();}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:'calculateProration',value:function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1],a=[],r=0,u={};if(t)r=this.data.subtotal,a=this.data.lines.data;else{var l,n=!0,d=!1;try{for(var s,i=this.data.lines.data[Symbol.iterator]();!(n=(s=i.next()).done);n=!0)u=s.value,u.period.start==e&&(a.push(u),r+=u.amount)}catch(e){d=!0,l=e}finally{try{!n&&i.return&&i.return()}finally{if(d)throw l}}}return Promise.resolve({proration_cost:r,proration_items:a})}}],[{key:'fetchAll',value:function(){var t=u(regeneratorRuntime.mark(function t(a){var r,u,l,n,d,s,i,o,p=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,a.stripe.invoices.list(p);case 3:for(r=t.sent,u=[],l=!0,n=!1,d=void 0,t.prev=8,s=r.data[Symbol.iterator]();!(l=(i=s.next()).done);l=!0)o=i.value,u.push(new e(a,o));t.next=16;break;case 12:t.prev=12,t.t0=t['catch'](8),n=!0,d=t.t0;case 16:t.prev=16,t.prev=17,!l&&s.return&&s.return();case 19:if(t.prev=19,!n){t.next=22;break}throw d;case 22:return t.finish(19);case 23:return t.finish(16);case 24:return t.abrupt('return',Promise.resolve(u));case 27:return t.prev=27,t.t1=t['catch'](0),t.abrupt('return',Promise.reject(t.t1));case 30:case'end':return t.stop();}},t,this,[[0,27],[8,12,16,24],[17,,19,23]])}));return function(){return t.apply(this,arguments)}}()}]),e}();t.default=x},function(e){e.exports=require('lodash/ceil')},function(e){e.exports=require('babel-polyfill')},function(e){e.exports=require('lodash/isString')},function(e){e.exports=require('lodash/head')},function(e,t,a){'use strict';function r(e){return e&&e.__esModule?e:{default:e}}function u(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,a){function r(u,l){try{var n=t[u](l),d=n.value}catch(e){return void a(e)}return n.done?void e(d):Promise.resolve(d).then(function(e){r('next',e)},function(e){r('throw',e)})}return r('next')})}}function l(e,t){if(!(e instanceof t))throw new TypeError('Cannot call a class as a function')}Object.defineProperty(t,'__esModule',{value:!0}),t.default=void 0;var n=a(17),d=r(n),s=a(9),i=r(s),o=a(19),p=r(o),f=a(14),c=r(f),v=a(33),h=r(v),b=a(1),_=r(b),m=a(5),x=r(m),y=a(7),g=r(y),k=a(2),w=r(k),j=a(3),P=r(j),S=a(0),I=r(S),M=a(6),q=r(M),C=function(){function e(e,t){for(var a,r=0;r<t.length;r++)a=t[r],a.enumerable=a.enumerable||!1,a.configurable=!0,'value'in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}return function(t,a,r){return a&&e(t.prototype,a),r&&e(t,r),t}}(),A=a(4),J=r(A),D=a(20),U=r(D),O=a(11),E=r(O),V=a(34),W=r(V),L=a(35),T=r(L),G=a(13),N=r(G),z=a(21),H=r(z),B=function(){function e(t,a){l(this,e),this.data={},this._stush={},this._stush=t,this.set(a,!0)}return C(e,[{key:'set',value:function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1],a=(0,q.default)(this.data);(0,I.default)(a,e),a=(0,D.formatCustomerData)(a),(0,D.validator)(a,t),this.data=a}},{key:'toJson',value:function(){return JSON.parse(JSON.stringify((0,P.default)(this,['data'])))}},{key:'save',value:function(){var e=u(regeneratorRuntime.mark(function e(){var t,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,t={},!(0,w.default)(this.data,'id')){e.next=9;break}return a=(0,D.validator)(this.data),e.next=6,this._stush.stripe.customers.update(this.data.id,a.value);case 6:t=e.sent,e.next=12;break;case 9:return e.next=11,this._stush.stripe.customers.create(this.data);case 11:t=e.sent;case 12:return this.set(t,!0),e.abrupt('return',Promise.resolve(this));case 16:return e.prev=16,e.t0=e['catch'](0),e.abrupt('return',Promise.reject(e.t0));case 19:case'end':return e.stop();}},e,this,[[0,16]])}));return function(){return e.apply(this,arguments)}}()},{key:'delete',value:function(){var e=u(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.data.id){e.next=2;break}throw(0,J.default)('Valid customer ID is required to delete the customer');case 2:return e.prev=2,e.next=5,this._stush.stripe.customers.del(this.data.id);case 5:return this.data=e.sent,e.abrupt('return',Promise.resolve(this));case 9:return e.prev=9,e.t0=e['catch'](2),e.abrupt('return',Promise.reject(e.t0));case 12:case'end':return e.stop();}},e,this,[[2,9]])}));return function(){return e.apply(this,arguments)}}()},{key:'selfPopulate',value:function(){var e=u(regeneratorRuntime.mark(function e(){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.data.id){e.next=2;break}return e.abrupt('return',Promise.reject((0,J.default)('Please provide a valid customer ID before self populating')));case 2:return e.prev=2,e.next=5,this._stush.stripe.customers.retrieve(this.data.id);case 5:return t=e.sent,(0,I.default)(this.data,t),e.abrupt('return',Promise.resolve(this));case 10:return e.prev=10,e.t0=e['catch'](2),e.abrupt('return',Promise.reject(e.t0));case 13:case'end':return e.stop();}},e,this,[[2,10]])}));return function(){return e.apply(this,arguments)}}()},{key:'fetchAllSources',value:function(){var e=u(regeneratorRuntime.mark(function e(){var t,a,r,u,l,n,d,s,i=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.data.id){e.next=2;break}throw(0,J.default)('Please provide a valid customer ID to add a new subscription.');case 2:return e.prev=2,e.next=5,this._stush.stripe.customers.listSources(this.data.id,i);case 5:for(t=e.sent,a=[],r=!0,u=!1,l=void 0,e.prev=10,n=t.data[Symbol.iterator]();!(r=(d=n.next()).done);r=!0)s=d.value,a.push(new W.default(this._stush,s));e.next=18;break;case 14:e.prev=14,e.t0=e['catch'](10),u=!0,l=e.t0;case 18:e.prev=18,e.prev=19,!r&&n.return&&n.return();case 21:if(e.prev=21,!u){e.next=24;break}throw l;case 24:return e.finish(21);case 25:return e.finish(18);case 26:return e.abrupt('return',Promise.resolve(a));case 29:return e.prev=29,e.t1=e['catch'](2),e.abrupt('return',Promise.reject(e.t1));case 32:case'end':return e.stop();}},e,this,[[2,29],[10,14,18,26],[19,,21,25]])}));return function(){return e.apply(this,arguments)}}()},{key:'attachSource',value:function(){var e=u(regeneratorRuntime.mark(function e(t){var a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this._stush.stripe.customers.createSource(this.data.id,{source:t});case 3:return a=e.sent,e.abrupt('return',Promise.resolve(new W.default(this._stush,a)));case 7:return e.prev=7,e.t0=e['catch'](0),e.abrupt('return',Promise.reject(e.t0));case 10:case'end':return e.stop();}},e,this,[[0,7]])}));return function(){return e.apply(this,arguments)}}()},{key:'updateSource',value:function(){var e=u(regeneratorRuntime.mark(function e(t){var a,r,u,l,n,d=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,a={metadata:(0,g.default)(d,['owner'])},(0,w.default)(d,'owner')&&(0,x.default)(a,'owner',(0,_.default)(d,'owner','')),e.next=5,this._stush.stripe.sources.update(t,a);case 5:return r=e.sent,e.abrupt('return',Promise.resolve(new W.default(this._stush,r)));case 9:if(e.prev=9,e.t0=e['catch'](0),!((0,w.default)(e.t0,'raw')&&(0,h.default)(e.t0.raw.message,'No such source'))){e.next=19;break}return u=['address_city','address_country','address_line1','address_line2','address_state','address_zip','exp_month','exp_year','name'],l={metadata:(0,g.default)(d,u)},(0,I.default)(l,(0,P.default)(d,u)),e.next=17,this._stush.stripe.customers.updateCard(this.data.id,t,l);case 17:return n=e.sent,e.abrupt('return',Promise.resolve(new W.default(this._stush,n)));case 19:return e.abrupt('return',Promise.reject(e.t0));case 20:case'end':return e.stop();}},e,this,[[0,9]])}));return function(){return e.apply(this,arguments)}}()},{key:'detachSource',value:function(){var e=u(regeneratorRuntime.mark(function e(t){var a,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this._stush.stripe.customers.deleteSource(this.data.id,{source:t});case 3:return a=e.sent,e.abrupt('return',Promise.resolve(new W.default(this._stush,a)));case 7:if(e.prev=7,e.t0=e['catch'](0),!((0,w.default)(e.t0,'raw')&&'id'===e.t0.raw.param&&(0,h.default)(e.t0.raw.message,'No such source'))){e.next=14;break}return e.next=12,this._stush.stripe.customers.deleteCard(this.data.id,t);case 12:return r=e.sent,e.abrupt('return',Promise.resolve(new W.default(this._stush,r)));case 14:return e.abrupt('return',Promise.reject(e.t0));case 15:case'end':return e.stop();}},e,this,[[0,7]])}));return function(){return e.apply(this,arguments)}}()},{key:'isSubscribed',value:function(){return 0!==(0,_.default)(this.data,'subscriptions.data.length',0)}},{key:'fetchSubscription',value:function(){var e=u(regeneratorRuntime.mark(function e(){var t,a,r,u,l,n,d,s,i=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.selfPopulate();case 2:if(t=(0,_.default)(this.data,'subscriptions'),a=void 0,!i){e.next=34;break}r=!0,u=!1,l=void 0,e.prev=8,n=t.data[Symbol.iterator]();case 10:if(r=(d=n.next()).done){e.next=18;break}if(s=d.value,i!==s.id){e.next=15;break}return a=s,e.abrupt('break',18);case 15:r=!0,e.next=10;break;case 18:e.next=24;break;case 20:e.prev=20,e.t0=e['catch'](8),u=!0,l=e.t0;case 24:e.prev=24,e.prev=25,!r&&n.return&&n.return();case 27:if(e.prev=27,!u){e.next=30;break}throw l;case 30:return e.finish(27);case 31:return e.finish(24);case 32:e.next=39;break;case 34:if('multiple'!==this._stush.fetchModel()){e.next=38;break}throw(0,J.default)('Subscription ID needs to be specified in Multiple Subscription Model.');case 38:a=(0,_.default)(this.data,'subscriptions.data.[0]',null);case 39:if(a){e.next=41;break}throw(0,J.default)('Specified customer is not subscribed to subscription with provided ID.');case 41:return e.abrupt('return',Promise.resolve(new H.default(this._stush,a)));case 42:case'end':return e.stop();}},e,this,[[8,20,24,32],[25,,27,31]])}));return function(){return e.apply(this,arguments)}}()},{key:'fetchSubscriptionByPlan',value:function(){var e=u(regeneratorRuntime.mark(function e(t){var a,r,u,l,n,d,s,i,o,p,f,c,v,h,b;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}throw(0,J.default)('Plan ID is required to fetch subscription by plan.');case 2:if(e.prev=2,(0,_.default)(this,'data.object',null)){e.next=6;break}return e.next=6,this.selfPopulate();case 6:a=(0,_.default)(this.data,'subscriptions'),r=void 0,u=!0,l=!1,n=void 0,e.prev=11,d=a.data[Symbol.iterator]();case 13:if(u=(s=d.next()).done){e.next=48;break}i=s.value,o=(0,_.default)(i,'items.data'),p=!0,f=!1,c=void 0,e.prev=19,v=o[Symbol.iterator]();case 21:if(p=(h=v.next()).done){e.next=29;break}if(b=h.value,t!==(0,_.default)(b,'plan.id')){e.next=26;break}return r=i,e.abrupt('break',29);case 26:p=!0,e.next=21;break;case 29:e.next=35;break;case 31:e.prev=31,e.t0=e['catch'](19),f=!0,c=e.t0;case 35:e.prev=35,e.prev=36,!p&&v.return&&v.return();case 38:if(e.prev=38,!f){e.next=41;break}throw c;case 41:return e.finish(38);case 42:return e.finish(35);case 43:if(!r){e.next=45;break}return e.abrupt('break',48);case 45:u=!0,e.next=13;break;case 48:e.next=54;break;case 50:e.prev=50,e.t1=e['catch'](11),l=!0,n=e.t1;case 54:e.prev=54,e.prev=55,!u&&d.return&&d.return();case 57:if(e.prev=57,!l){e.next=60;break}throw n;case 60:return e.finish(57);case 61:return e.finish(54);case 62:if(r){e.next=64;break}throw(0,J.default)('Customer is not subscribed to subscription with specified plan.');case 64:return e.abrupt('return',Promise.resolve(new H.default(this._stush,r)));case 67:return e.prev=67,e.t2=e['catch'](2),e.abrupt('return',Promise.reject(e.t2));case 70:case'end':return e.stop();}},e,this,[[2,67],[11,50,54,62],[19,31,35,43],[36,,38,42],[55,,57,61]])}));return function(){return e.apply(this,arguments)}}()},{key:'fetchAllSubscriptions',value:function(){var e,t=(0,_.default)(this.data,'subscriptions.data'),a=new Set,r=!0,u=!1;try{for(var l,n,d=t[Symbol.iterator]();!(r=(l=d.next()).done);r=!0)n=l.value,a.add(new H.default(this._stush,n))}catch(t){u=!0,e=t}finally{try{!r&&d.return&&d.return()}finally{if(u)throw e}}return a}},{key:'addSubscription',value:function(){var e=u(regeneratorRuntime.mark(function e(t){var a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,this.data.id){e.next=3;break}return e.abrupt('return',Promise.reject((0,J.default)('Please provide a valid customer ID to add a new subscription.')));case 3:return a=t.clone(),(0,x.default)(a,'data.customer',this.data.id),e.next=7,a.save();case 7:return e.next=9,this.selfPopulate();case 9:return e.abrupt('return',Promise.resolve(a));case 12:return e.prev=12,e.t0=e['catch'](0),e.abrupt('return',Promise.reject(e.t0));case 15:case'end':return e.stop();}},e,this,[[0,12]])}));return function(){return e.apply(this,arguments)}}()},{key:'endSubscription',value:function(){var e=u(regeneratorRuntime.mark(function e(){var t,a,r=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,r||'multiple'!==this._stush.fetchModel()){e.next=3;break}return e.abrupt('return',Promise.reject({isJoi:!0,details:[{message:'Valid subscription is required in Multiple Subscription Model.',code:500}]}));case 3:if(r&&(0,w.default)(r,'data.id')){e.next=10;break}return e.next=6,this.selfPopulate();case 6:return e.next=8,this.fetchSubscription();case 8:t=e.sent,(0,I.default)(r.data,t.data);case 10:return e.next=12,r.cancel();case 12:return a=e.sent,e.abrupt('return',Promise.resolve(a));case 16:return e.prev=16,e.t0=e['catch'](0),e.abrupt('return',Promise.reject(e.t0));case 19:case'end':return e.stop();}},e,this,[[0,16]])}));return function(){return e.apply(this,arguments)}}()},{key:'changeSubscription',value:function(){var e=u(regeneratorRuntime.mark(function e(t){var a,r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.selfPopulate();case 3:if('multiple'!==this._stush.fetchModel()||r){e.next=5;break}return e.abrupt('return',Promise.reject({isJoi:!0,details:[{message:'Valid subscription is required in Multiple Subscription Model.',code:500}]}));case 5:if(r){e.next=9;break}return e.next=8,this.fetchSubscription();case 8:r=e.sent;case 9:return a=r.clone(),e.next=12,a.change(t);case 12:return e.abrupt('return',Promise.resolve(a));case 15:return e.prev=15,e.t0=e['catch'](0),e.abrupt('return',Promise.reject(e.t0));case 18:case'end':return e.stop();}},e,this,[[0,15]])}));return function(){return e.apply(this,arguments)}}()},{key:'previewProration',value:function(){var e=u(regeneratorRuntime.mark(function e(t){var a,r,u,l,n,d,s,o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if((0,_.default)(t,'data.cancellation_proration',!1)||!(0,w.default)(t,'data.id')){e.next=2;break}throw(0,J.default)('Existing subscription cannot be passed to preview plan change proration.');case 2:return e.prev=2,e.next=5,this.selfPopulate();case 5:if('multiple'!==this._stush.fetchModel()||(0,w.default)(o,'data.id')||(0,_.default)(t,'data.cancellation_proration',!1)){e.next=7;break}return e.abrupt('return',Promise.reject({isJoi:!0,details:[{message:'Valid subscription is required in Multiple Subscription Model.',code:500}]}));case 7:if(o){e.next=15;break}if(!(0,_.default)(t,'data.cancellation_proration',!1)){e.next=12;break}o=t.clone(),e.next=15;break;case 12:return e.next=14,this.fetchSubscription();case 14:o=e.sent;case 15:if(!(0,w.default)(o,'data.id')){e.next=18;break}return e.next=18,o.selfPopulate();case 18:return a={},r=o.fetchSubscriptionItem(),(0,x.default)(a,'value.subscription',o),(0,x.default)(a,'value.prorate_from',(0,_.default)(t,'data.prorate_from',(0,c.default)(new Date/1e3))),(0,x.default)(t,'data.items[0].id',(0,_.default)(r,'id')),(0,x.default)(a,'value.items',(0,_.default)(t,'data.items')),(0,w.default)(t,'data.items')&&(0,p.default)((0,_.default)(t,'data.items'))||((0,x.default)(a,'value.plan_to_change',(0,_.default)(r,'plan.id')),(0,x.default)(a,'value.items',[{id:r.id,plan:(0,_.default)(t,'data.items[0].plan',(0,_.default)(t,'data.items.data[0].plan.id'))}])),(0,_.default)(t,'data.cancellation_proration')?(0,x.default)(a,'value.preview_cancellation_refund',!0):(0,x.default)(a,'value.preview_proration',!0),(0,i.default)(a,'value.cancellation_proration'),e.next=28,this.fetchUpcomingInvoice(a.value);case 28:return u=e.sent,l=new E.default(this._stush,{id:(0,_.default)(r,'plan.id')}),e.next=32,l.selfPopulate();case 32:return n=new E.default(this._stush,{id:(0,_.default)(a,'value.items[0].plan')}),e.next=35,n.selfPopulate();case 35:return d=l.getInterval()!==n.getInterval()||0===(0,_.default)(l,'data.amount')&&0!==(0,_.default)(n,'data.amount'),e.next=38,u.calculateProration((0,_.default)(a,'value.prorate_from'),d);case 38:return s=e.sent,(0,x.default)(s,'upcoming_invoice',u.toJson()),e.abrupt('return',Promise.resolve(s));case 43:return e.prev=43,e.t0=e['catch'](2),e.abrupt('return',Promise.reject(e.t0));case 46:case'end':return e.stop();}},e,this,[[2,43]])}));return function(){return e.apply(this,arguments)}}()},{key:'refund',value:function(){var e=u(regeneratorRuntime.mark(function e(t){var a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this._stush.stripe.refunds.create(t);case 3:return a=e.sent,e.abrupt('return',Promise.resolve(new T.default(this._stush,a)));case 7:return e.prev=7,e.t0=e['catch'](0),e.abrupt('return',Promise.reject(e.t0));case 10:case'end':return e.stop();}},e,this,[[0,7]])}));return function(){return e.apply(this,arguments)}}()},{key:'fetchAllInvoices',value:function(){var e=u(regeneratorRuntime.mark(function e(){var t,a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,(0,I.default)(a,{customer:this.data.id}),e.next=4,N.default.fetchAll(this._stush,a);case 4:return t=e.sent,e.abrupt('return',Promise.resolve(t));case 8:return e.prev=8,e.t0=e['catch'](0),e.abrupt('return',Promise.reject(e.t0));case 11:case'end':return e.stop();}},e,this,[[0,8]])}));return function(){return e.apply(this,arguments)}}()},{key:'fetchUpcomingInvoice',value:function(){var e=u(regeneratorRuntime.mark(function e(t){var a,r,u,l;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,this.data.id){e.next=3;break}return e.abrupt('return',Promise.reject((0,J.default)('Please provide a valid customer ID to add a new subscription.')));case 3:if(a=void 0,r=void 0,u=new N.default(this._stush),l={customer:this.data.id},!((0,w.default)(t,'preview_cancellation_refund')||(0,w.default)(t,'preview_proration'))){e.next=15;break}if(a=(0,_.default)(t,'subscription'),'string'!=typeof a){e.next=10;break}return e.next=9,this.fetchSubscription((0,_.default)(t,'subscription'));case 9:a=e.sent;case 10:r=(0,_.default)(t,'items',[]),(0,w.default)(t,'items')||(r=[{id:a.data.items.data[0].id,plan:a.data.items.data[0].plan.id}]),(0,x.default)(l,'subscription_items',r),(0,x.default)(l,'subscription_proration_date',(0,_.default)(t,'refund_value_from',(0,_.default)(t,'prorate_from'))),(0,_.default)(t,'preview_cancellation_refund',!1)&&(0,x.default)(l,'subscription_items[0].quantity',0);case 15:return(0,w.default)(t,'subscription')&&('string'==typeof(0,_.default)(t,'subscription')?(0,x.default)(l,'subscription',(0,_.default)(t,'subscription')):(0,x.default)(l,'subscription',(0,_.default)(t,'subscription.data.id'))),e.next=18,u.populateWithUpcoming(l);case 18:return e.abrupt('return',Promise.resolve(u));case 21:return e.prev=21,e.t0=e['catch'](0),e.abrupt('return',Promise.reject(e.t0));case 24:case'end':return e.stop();}},e,this,[[0,21]])}));return function(){return e.apply(this,arguments)}}()},{key:'fetchAnInvoice',value:function(){var e=u(regeneratorRuntime.mark(function e(){var t,a,r=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t={limit:1,customer:this.data.id},(0,I.default)(t,r),e.next=5,this._stush.stripe.invoices.list(t);case 5:return a=e.sent,e.abrupt('return',Promise.resolve(new N.default(this._stush,(0,d.default)(a.data))));case 9:return e.prev=9,e.t0=e['catch'](0),e.abrupt('return',Promise.reject(e.t0));case 12:case'end':return e.stop();}},e,this,[[0,9]])}));return function(){return e.apply(this,arguments)}}()},{key:'fetchLatestPlan',value:function(){var e=u(regeneratorRuntime.mark(function e(){var t,a,r,u=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.fetchSubscription(u);case 2:return t=e.sent,a=t.fetchLatestPlan(),r=new E.default(this._stush,{id:a}),e.next=7,r.selfPopulate();case 7:return e.abrupt('return',r);case 8:case'end':return e.stop();}},e,this)}));return function(){return e.apply(this,arguments)}}()}],[{key:'fetchAll',value:function(){var t=u(regeneratorRuntime.mark(function t(a){var r,u,l,n,d,s,i,o,p=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,a.stripe.customers.list(p);case 3:for(r=t.sent,u=[],l=!0,n=!1,d=void 0,t.prev=8,s=r.data[Symbol.iterator]();!(l=(i=s.next()).done);l=!0)o=i.value,u.push(new e(a,o));t.next=16;break;case 12:t.prev=12,t.t0=t['catch'](8),n=!0,d=t.t0;case 16:t.prev=16,t.prev=17,!l&&s.return&&s.return();case 19:if(t.prev=19,!n){t.next=22;break}throw d;case 22:return t.finish(19);case 23:return t.finish(16);case 24:return t.abrupt('return',Promise.resolve(u));case 27:return t.prev=27,t.t1=t['catch'](0),t.abrupt('return',Promise.reject(t.t1));case 30:case'end':return t.stop();}},t,this,[[0,27],[8,12,16,24],[17,,19,23]])}));return function(){return t.apply(this,arguments)}}()}]),e}();t.default=B},function(e){e.exports=require('lodash/isArray')},function(e,t,a){'use strict';function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,'__esModule',{value:!0}),t.cancelSubscriptionValidator=t.previewProrationValidator=t.formatCustomerData=t.validator=t.cancelSubscriptionSchema=t.previewProrationSchema=void 0;var u=a(9),l=r(u),n=a(1),d=r(n),s=a(0),i=r(s),o=a(2),p=r(o),f=a(7),c=r(f),v=a(10),h=r(v),b=a(3),_=r(b),m=a(5),x=r(m),y=a(14),g=r(y),k=a(8),w=r(k),j=w.default.object().keys({id:w.default.string(),object:w.default.string(),created:w.default.number().positive(),currency:w.default.string().allow(null),delinquent:w.default.boolean(),discount:w.default.object().allow(null),livemode:w.default.boolean(),sources:w.default.object(),subscriptions:w.default.object(),email:w.default.string().email().when('id',{is:!w.default.exist(),then:w.default.required()}),metadata:w.default.object(),source:w.default.string().token(),default_source:w.default.string().token().allow(null),account_balance:w.default.number().min(0),business_vat_id:w.default.string().allow(null),coupon:w.default.string().allow(null),description:w.default.string().allow(null),shipping:w.default.object().keys({name:w.default.string().required(),phone:w.default.string(),address:w.default.object().keys({line1:w.default.string().required(),city:w.default.string(),country:w.default.string(),line2:w.default.string(),postal_code:w.default.string(),state:w.default.string()}).required()}).allow(null)}),P=t.previewProrationSchema=w.default.object().keys({subscription:w.default.alternatives([w.default.string().token(),w.default.object()]),cancellation_proration:w.default.boolean().default(!1),plan_to_change:w.default.string(),plan:w.default.string().when('cancellation_proration',{is:!1,then:w.default.required()}),prorate_from:w.default.number().positive().when('cancellation_proration',{is:!1,then:w.default.required()})}),S=t.cancelSubscriptionSchema=w.default.object().keys({subscription:w.default.string().token(),cancel:w.default.string().valid('now','after_billing_cycle').default('now'),refund:w.default.number().positive(),refund_value_from:w.default.number().positive().default((0,g.default)(new Date().getTime()/1e3)).when('refund',{is:w.default.exist(),then:w.default.strip()})}),I=t.validator=function(e){var t=1<arguments.length&&arguments[1]!==void 0&&arguments[1],a={};t&&(0,x.default)(a,'allowUnknown',!0);var r=w.default.validate(e,j,a);if(r.error)throw r.error;if(!t){(0,x.default)(r,'value',stripEmptyObjects((0,_.default)(e,['metadata','name','statement_descriptor'])))}return r},M=t.formatCustomerData=function(e){var t=['id','object','email','source','default_source','account_balance','business_vat_id','coupon','description','metadata','created','currency','delinquent','discount','livemode','shipping','sources','subscriptions'];console.log('First ',(0,_.default)(e,(0,h.default)((0,c.default)(e,t)))),console.log('Remastered ',(0,c.default)(e,t));var a=(0,_.default)(e,(0,h.default)((0,c.default)(e,t)));return(0,p.default)(e,'metadata')||(0,x.default)(e,'metadata',{}),(0,i.default)((0,d.default)(e,'metadata'),a),deleteProperties(e,(0,h.default)((0,c.default)(e,t))),e},q=t.previewProrationValidator=function(e){var t=w.default.validate(e,P);if(t.error)throw t.error;var a=(0,d.default)(e,'subscription'),r=a.fetchSubscriptionItem((0,d.default)(e,'plan_to_change',null));return(0,x.default)(t,'value.plan_to_change',(0,d.default)(r,'plan.id')),(0,x.default)(t,'value.items',[{id:r.id,plan:(0,d.default)(e,'plan')}]),(0,d.default)(e,'cancellation_proration')?(0,x.default)(t,'value.preview_cancellation_refund',!0):(0,x.default)(t,'value.preview_proration',!0),(0,l.default)(t,'value.cancellation_proration'),t},C=t.cancelSubscriptionValidator=function(e){(0,p.default)(e,'id')&&(0,x.default)(e,'subscription',(0,d.default)(e,'id'));var t=w.default.validate(e,S,{stripUnknown:!0});if(t.error)throw t.error;return t};t.default=j},function(e,t,a){'use strict';function r(e){return e&&e.__esModule?e:{default:e}}function u(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,a){function r(u,l){try{var n=t[u](l),d=n.value}catch(e){return void a(e)}return n.done?void e(d):Promise.resolve(d).then(function(e){r('next',e)},function(e){r('throw',e)})}return r('next')})}}function l(e,t){if(!(e instanceof t))throw new TypeError('Cannot call a class as a function')}Object.defineProperty(t,'__esModule',{value:!0}),t.default=void 0;var n=a(14),d=r(n),s=a(5),i=r(s),o=a(1),p=r(o),f=a(3),c=r(f),v=a(2),h=r(v),b=a(0),_=r(b),m=a(6),x=r(m),y=function(){function e(e,t){for(var a,r=0;r<t.length;r++)a=t[r],a.enumerable=a.enumerable||!1,a.configurable=!0,'value'in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}return function(t,a,r){return a&&e(t.prototype,a),r&&e(t,r),t}}(),g=a(36),k=r(g),w=a(20),j=r(w),P=a(4),S=r(P),I=a(11),M=r(I),q=a(13),C=r(q),A=a(18),J=r(A),D=function(){function e(t,a){l(this,e),this.data={},this._stush={},this._stush=t,this.set(a)}return y(e,[{key:'set',value:function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1],a=(0,x.default)(this.data);(0,_.default)(a,e),debug(a),a=(0,g.formatSubscriptionData)(a),debug(a),(0,g.validator)(a,t),debug(a),this.data=a}},{key:'save',value:function(){var e=u(regeneratorRuntime.mark(function e(){var t,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,t={},(0,g.stripConfigOptions)(this.data),!(0,h.default)(this.data,'id')){e.next=10;break}return a=(0,g.validator)(this.data),e.next=7,this._stush.stripe.subscriptions.update(this.data.id,a.value);case 7:t=e.sent,e.next=13;break;case 10:return e.next=12,this._stush.stripe.subscriptions.create(this.data);case 12:t=e.sent;case 13:return this.set(t,!0),e.abrupt('return',Promise.resolve(this));case 17:return e.prev=17,e.t0=e['catch'](0),e.abrupt('return',Promise.reject(e.t0));case 20:case'end':return e.stop();}},e,this,[[0,17]])}));return function(){return e.apply(this,arguments)}}()},{key:'selfPopulate',value:function(){var e=u(regeneratorRuntime.mark(function e(){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.data.id){e.next=2;break}return e.abrupt('return',Promise.reject((0,S.default)('Please provide a valid subscription ID before self populating.')));case 2:return e.prev=2,e.next=5,this._stush.stripe.subscriptions.retrieve(this.data.id);case 5:return t=e.sent,(0,_.default)(this.data,t),e.abrupt('return',Promise.resolve(this));case 10:return e.prev=10,e.t0=e['catch'](2),e.abrupt('return',Promise.reject(e.t0));case 13:case'end':return e.stop();}},e,this,[[2,10]])}));return function(){return e.apply(this,arguments)}}()},{key:'clone',value:function(){return new e(this._stush,(0,x.default)(this.data))}},{key:'toJson',value:function(){return JSON.parse(JSON.stringify((0,c.default)(this,['data'])))}},{key:'fetchSubscriptionItem',value:function(){var e,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null,a=(0,p.default)(this.data,'items.data');if(t){var r,u=!0,l=!1;try{for(var n,d,s=a[Symbol.iterator]();!(u=(n=s.next()).done);u=!0)if(d=n.value,t===d.plan.id){e=d;break}}catch(e){l=!0,r=e}finally{try{!u&&s.return&&s.return()}finally{if(l)throw r}}if(!e)throw(0,S.default)('Specified customer is not subscribed to subscription with provided plan.')}else e=(0,p.default)(this.data,'items.data.[0]',{});return e}},{key:'fetchLatestPlan',value:function(){var e,t=(0,p.default)(this.data,'items.data'),a=!0,r=!1;try{for(var u,l,n=t[Symbol.iterator]();!(a=(u=n.next()).done);a=!0)if(l=u.value,(0,h.default)(l,'plan'))return Promise.resolve((0,p.default)(l,'plan.id'))}catch(t){r=!0,e=t}finally{try{!a&&n.return&&n.return()}finally{if(r)throw e}}}},{key:'change',value:function(){var e=u(regeneratorRuntime.mark(function e(t){var a,r,u,l,n,s,o,f,c,v;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}throw(0,S.default)('Subscription to change to is required.');case 2:if(e.prev=2,a={},r=this.fetchSubscriptionItem(),(0,i.default)(a,'items',(0,p.default)(t,'data.items')),(0,i.default)(a,'items[0].id',(0,p.default)(r,'id')),(0,h.default)(t,'data.tax_percent')&&(0,i.default)(a,'tax_percent',(0,p.default)(t,'data.tax_percent','')),(0,h.default)(t,'data.billing')&&(0,i.default)(a,'billing',(0,p.default)(t,'data.billing','charge_automatically')),(0,h.default)(t,'data.days_until_due')&&(0,i.default)(a,'days_until_due',(0,p.default)(t,'data.days_until_due',30)),u=this._stush.fetchProrationSetting(),'all'!==u&&'change_subscription'!==u){e.next=14;break}(0,i.default)(a,'proration_date',(0,p.default)(t,'data.prorate_from',(0,d.default)(new Date/1e3))),e.next=17;break;case 14:if(!(0,h.default)(t,'data.prorate_from')){e.next=16;break}return e.abrupt('return',Promise.reject({isJoi:!0,details:[{message:'Proration is disabled in configuration options.',code:500}]}));case 16:(0,i.default)(a,'prorate',!1);case 17:return l=new M.default(this._stush,{id:(0,p.default)(this,'data.items.data[0].plan.id')}),e.next=20,l.selfPopulate();case 20:return n=new M.default(this._stush,{id:(0,p.default)(t,'data.items[0].plan',(0,p.default)(t,'data.items.data[0].plan.id'))}),e.next=23,n.selfPopulate();case 23:return s=l.getInterval()!==n.getInterval(),o=0===(0,p.default)(l,'data.amount'),f=(0,p.default)(n,'data.amount')>(0,p.default)(l,'data.amount'),c=this._stush.chargesInstantly(),debug('Final params >>>>>>>>>>>>>>>>>>.  ',a),e.next=27,this._stush.stripe.subscriptions.update(this.data.id,a);case 27:if(this.data=e.sent,s||o||!f||!c){e.next=33;break}return debug('Generating a new invoice.'),v=new C.default(this._stush,{customer:(0,p.default)(this,'data.customer'),subscription:(0,p.default)(this,'data.id')}),e.next=33,v.save();case 33:return e.abrupt('return',Promise.resolve(this));case 36:return e.prev=36,e.t0=e['catch'](2),e.abrupt('return',Promise.reject(e.t0));case 39:case'end':return e.stop();}},e,this,[[2,36]])}));return function(){return e.apply(this,arguments)}}()},{key:'cancel',value:function(){var e=u(regeneratorRuntime.mark(function e(){var t,a,r,u,l,n,d,s,o,f,c,v;return regeneratorRuntime.wrap(function(e){for(var b=Math.sign;;)switch(e.prev=e.next){case 0:if((0,h.default)(this,'data.id')){e.next=2;break}throw(0,S.default)('Please populate the Subscription instance before attempting to cancel it.');case 2:if(e.prev=2,t={},a={},r=(0,w.cancelSubscriptionValidator)((0,p.default)(this,'data',{})),u='after_billing_cycle'===r.value.cancel,(0,h.default)(this,'data.customer')){e.next=8;break}return e.next=8,this.selfPopulate();case 8:return l=new J.default(this._stush,{id:(0,p.default)(this,'data.customer')}),e.next=11,l.selfPopulate();case 11:if(n=this._stush.fetchProrationSetting(),!(n&&!u&&((0,h.default)(r,'value.refund')||(0,h.default)(r,'value.refund_value_from')))){e.next=27;break}return e.next=15,l.fetchAnInvoice({subscription:this.data.id});case 15:if(d=e.sent,(0,i.default)(a,'charge',(0,p.default)(d,'data.charge')),!(0,h.default)(r,'value.refund')){e.next=21;break}(0,i.default)(a,'amount',(0,p.default)(r,'value.refund')),e.next=27;break;case 21:return e.next=23,l.fetchUpcomingInvoice({preview_cancellation_refund:!0,customer:(0,p.default)(this,'data.id'),subscription:(0,p.default)(this,'data.id'),refund_value_from:(0,p.default)(r,'value.refund_value_from')});case 23:s=e.sent,o=s.calculateProration((0,p.default)(r,'value.refund_value_from')),f=(0,p.default)(o,'proration_cost'),(-1===b(f)||-0===b(f))&&(0,i.default)(a,'amount',Math.abs(f));case 27:return c={},u&&(0,i.default)(c,'at_period_end',!0),e.next=31,this._stush.stripe.subscriptions.del(this.data.id,c);case 31:if(this.data=e.sent,(0,i.default)(t,'subscription',this.toJson()),(0,i.default)(t,'refund',null),!(!u&&((0,h.default)(r,'value.refund')||(0,h.default)(r,'value.refund_value_from')))){e.next=39;break}return e.next=37,l.refund(a);case 37:v=e.sent,(0,i.default)(t,'refund',v.toJson());case 39:return e.abrupt('return',Promise.resolve(t));case 42:return e.prev=42,e.t0=e['catch'](2),e.abrupt('return',Promise.reject(e.t0));case 45:case'end':return e.stop();}},e,this,[[2,42]])}));return function(){return e.apply(this,arguments)}}()}],[{key:'fetchAll',value:function(){var e=u(regeneratorRuntime.mark(function e(t){var a,r,u,l,n,d,s,i,o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t.stripe.subscriptions.list(o);case 3:for(a=e.sent,r=[],u=!0,l=!1,n=void 0,e.prev=8,d=a.data[Symbol.iterator]();!(u=(s=d.next()).done);u=!0)i=s.value,r.push(new C.default(t,i));e.next=16;break;case 12:e.prev=12,e.t0=e['catch'](8),l=!0,n=e.t0;case 16:e.prev=16,e.prev=17,!u&&d.return&&d.return();case 19:if(e.prev=19,!l){e.next=22;break}throw n;case 22:return e.finish(19);case 23:return e.finish(16);case 24:return e.abrupt('return',Promise.resolve(r));case 27:return e.prev=27,e.t1=e['catch'](0),e.abrupt('return',Promise.reject(e.t1));case 30:case'end':return e.stop();}},e,this,[[0,27],[8,12,16,24],[17,,19,23]])}));return function(){return e.apply(this,arguments)}}()}]),e}();t.default=D,e.exports=D},function(e,t,a){a(15),e.exports=a(23)},function(e,t,a){'use strict';function r(e){return e&&e.__esModule?e:{default:e}}function u(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,a){function r(u,l){try{var n=t[u](l),d=n.value}catch(e){return void a(e)}return n.done?void e(d):Promise.resolve(d).then(function(e){r('next',e)},function(e){r('throw',e)})}return r('next')})}}function l(e,t){if(!(e instanceof t))throw new TypeError('Cannot call a class as a function')}var n=a(2),d=r(n),s=a(0),i=r(s),o=a(1),p=r(o),f=function(){function e(e,t){for(var a,r=0;r<t.length;r++)a=t[r],a.enumerable=a.enumerable||!1,a.configurable=!0,'value'in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}return function(t,a,r){return a&&e(t.prototype,a),r&&e(t,r),t}}(),c=a(24),v=r(c),h=a(25),b=r(h),_=a(26),m=r(_),x=a(11),y=r(x),g=a(31),k=r(g),w=a(13),j=r(w),P=a(18),S=r(P),I=a(21),M=r(I),q=a(4),C=r(q),A=a(38),J=a(42),D=r(J),U=a(43),O=r(U),E=a(44),V=r(E);global._babelPolyfill||a(15),(0,A.makeUtilsGlobal)();var W=function(){function e(t){l(this,e),this.userOptions={subscription_model:'multiple',proration:'change_subscription',charge_instantly:!1,worker_instances:1,cache:new b.default.Cache,cache_plans:86400},this.stripe={},this._queue=new D.default(function(e,t){O.default.process(e,t)},{concurrent:(0,p.default)(this,'userOptions.worker_instances',1)}),this._emitter=new V.default,this.validator=new m.default,this.validator.validateStushOptions(t),(0,i.default)(this.userOptions,t),this.stripe=new v.default((0,p.default)(this.userOptions,'secret'))}return f(e,[{key:'fetchWebhookSecret',value:function(){return(0,p.default)(this,'userOptions.webhook_secret',null)}},{key:'fetchModel',value:function(){return(0,p.default)(this,'userOptions.subscription_model')}},{key:'fetchProrationSetting',value:function(){return(0,p.default)(this,'userOptions.proration')}},{key:'chargesInstantly',value:function(){return(0,p.default)(this,'userOptions.charge_instantly')}},{key:'fetchCacheInstance',value:function(){return(0,p.default)(this,'userOptions.cache')}},{key:'fetchCacheLifetime',value:function(){return(0,p.default)(this,'userOptions.cache_plans')}},{key:'createPlan',value:function(){var e=u(regeneratorRuntime.mark(function e(t){var a,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,a=this.validator.createPlanInput(t),r=new y.default(this,a.value),e.next=5,r.save();case 5:return e.abrupt('return',Promise.resolve(r));case 8:if(e.prev=8,e.t0=e['catch'](0),!(0,p.default)(e.t0,'isJoi',null)){e.next=12;break}return e.abrupt('return',Promise.reject((0,C.default)(e.t0.details)));case 12:return e.abrupt('return',Promise.reject((0,C.default)(null,e.t0)));case 13:case'end':return e.stop();}},e,this,[[0,8]])}));return function(){return e.apply(this,arguments)}}()},{key:'deletePlan',value:function(){var e=u(regeneratorRuntime.mark(function e(t){var a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,a=new y.default(this,{id:t}),e.next=4,a.delete();case 4:return e.abrupt('return',Promise.resolve(a));case 7:if(e.prev=7,e.t0=e['catch'](0),!(0,p.default)(e.t0,'isJoi',null)){e.next=11;break}return e.abrupt('return',Promise.reject((0,C.default)(e.t0.details)));case 11:return e.abrupt('return',Promise.reject((0,C.default)(null,e.t0)));case 12:case'end':return e.stop();}},e,this,[[0,7]])}));return function(){return e.apply(this,arguments)}}()},{key:'fetchAllPlans',value:function(){var e=u(regeneratorRuntime.mark(function e(t){var a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,y.default.fetchAll(this,t);case 3:return a=e.sent,e.abrupt('return',Promise.resolve(a));case 7:if(e.prev=7,e.t0=e['catch'](0),!(0,p.default)(e.t0,'isJoi',null)){e.next=11;break}return e.abrupt('return',Promise.reject((0,C.default)(e.t0.details)));case 11:return e.abrupt('return',Promise.reject((0,C.default)(null,e.t0)));case 12:case'end':return e.stop();}},e,this,[[0,7]])}));return function(){return e.apply(this,arguments)}}()},{key:'createCustomer',value:function(){var e=u(regeneratorRuntime.mark(function e(t){var a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,a=new S.default(this,t),e.next=4,a.save();case 4:return e.abrupt('return',Promise.resolve(a));case 7:if(e.prev=7,e.t0=e['catch'](0),!(0,p.default)(e.t0,'isJoi',null)){e.next=11;break}return e.abrupt('return',Promise.reject((0,C.default)(e.t0.details)));case 11:return e.abrupt('return',Promise.reject((0,C.default)(null,e.t0)));case 12:case'end':return e.stop();}},e,this,[[0,7]])}));return function(){return e.apply(this,arguments)}}()},{key:'getCustomer',value:function(){var e=u(regeneratorRuntime.mark(function e(t){var a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,a=new S.default(this,{id:t}),e.next=4,a.selfPopulate();case 4:return e.abrupt('return',Promise.resolve(a));case 7:return e.prev=7,e.t0=e['catch'](0),e.abrupt('return',Promise.reject(e.t0));case 10:case'end':return e.stop();}},e,this,[[0,7]])}));return function(){return e.apply(this,arguments)}}()},{key:'deleteCustomer',value:function(){var e=u(regeneratorRuntime.mark(function e(t){var a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,a=new S.default(this,{id:t}),e.next=4,a.delete();case 4:return e.abrupt('return',Promise.resolve(a));case 7:return e.prev=7,e.t0=e['catch'](0),e.abrupt('return',Promise.reject(e.t0));case 10:case'end':return e.stop();}},e,this,[[0,7]])}));return function(){return e.apply(this,arguments)}}()},{key:'createSubscription',value:function(){var e=u(regeneratorRuntime.mark(function e(t){var a,r,u,l;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(a=this.validator.createSubscriptionInput(t),a.error){e.next=31;break}if(e.prev=2,r=new M.default(this,(0,p.default)(a,'value.subscription')),u=new S.default(this,(0,p.default)(a,'value.customer')),!(0,d.default)(a,'value.customer.id')){e.next=15;break}return e.next=7,u.selfPopulate();case 7:if('single'!==this.fetchModel()){e.next=10;break}if(!u.isSubscribed()){e.next=10;break}return e.abrupt('return',Promise.reject((0,C.default)('Only one subscription is allowed per user in "single subscription model"')));case 10:return e.next=12,u.addSubscription(r);case 12:r=e.sent,e.next=20;break;case 15:return e.next=17,u.save();case 17:return e.next=19,u.addSubscription(r);case 19:r=e.sent;case 20:return l={data:{customer:u,subscription:r},code:200},e.abrupt('return',Promise.resolve(l));case 24:if(e.prev=24,e.t0=e['catch'](2),!(0,p.default)(e.t0,'isJoi',null)){e.next=28;break}return e.abrupt('return',Promise.reject((0,C.default)(e.t0.details)));case 28:return e.abrupt('return',Promise.reject((0,C.default)(null,e.t0)));case 29:e.next=32;break;case 31:return e.abrupt('return',Promise.reject((0,C.default)(a.error.details)));case 32:case'end':return e.stop();}},e,this,[[2,24]])}));return function(){return e.apply(this,arguments)}}()},{key:'changeSubscription',value:function(){var e=u(regeneratorRuntime.mark(function e(t,a){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(a){e.next=2;break}throw(0,C.default)('Subscription to change is required.');case 2:if(e.prev=2,(0,p.default)(a,'data.object',null)){e.next=8;break}return debug(a),process.exit(),e.next=8,a.selfPopulate();case 8:return r=a.clone(),e.next=11,r.change(t);case 11:return e.abrupt('return',Promise.resolve(r));case 14:if(e.prev=14,e.t0=e['catch'](2),!(0,p.default)(e.t0,'isJoi',null)){e.next=18;break}return e.abrupt('return',Promise.reject((0,C.default)(e.t0.details)));case 18:return e.abrupt('return',Promise.reject((0,C.default)(null,e.t0)));case 19:case'end':return e.stop();}},e,this,[[2,14]])}));return function(){return e.apply(this,arguments)}}()},{key:'cancelSubscription',value:function(){var e=u(regeneratorRuntime.mark(function e(){var t,a,r=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r){e.next=2;break}throw(0,C.default)('Subscription is required for cancellation.');case 2:if(e.prev=2,'string'!=typeof r){e.next=8;break}return t=new M.default(this,{id:r}),e.next=7,t.selfPopulate();case 7:r=t.clone();case 8:return e.next=10,r.cancel();case 10:return a=e.sent,e.abrupt('return',Promise.resolve(a));case 14:if(e.prev=14,e.t0=e['catch'](2),!(0,p.default)(e.t0,'isJoi',null)){e.next=18;break}return e.abrupt('return',Promise.reject((0,C.default)(e.t0.details)));case 18:return e.abrupt('return',Promise.reject((0,C.default)(null,e.t0)));case 19:case'end':return e.stop();}},e,this,[[2,14]])}));return function(){return e.apply(this,arguments)}}()},{key:'validateCoupon',value:function(){var e=u(regeneratorRuntime.mark(function e(t){var a,r,u,l,n,d,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,a=k.default.fetchAll(this),r=!0,u=!1,l=void 0,e.prev=5,n=a[Symbol.iterator]();case 7:if(r=(d=n.next()).done){e.next=14;break}if(s=d.value,t!==(0,p.default)(s,'data.id')){e.next=11;break}return e.abrupt('return',Promise.resolve(s));case 11:r=!0,e.next=7;break;case 14:e.next=20;break;case 16:e.prev=16,e.t0=e['catch'](5),u=!0,l=e.t0;case 20:e.prev=20,e.prev=21,!r&&n.return&&n.return();case 23:if(e.prev=23,!u){e.next=26;break}throw l;case 26:return e.finish(23);case 27:return e.finish(20);case 28:return e.abrupt('return',Promise.reject({isJoi:!0,details:{message:'Invalid coupon code!',code:404}}));case 31:return e.prev=31,e.t1=e['catch'](0),e.abrupt('return',Promise.reject(e.t1));case 34:case'end':return e.stop();}},e,this,[[0,31],[5,16,20,28],[21,,23,27]])}));return function(){return e.apply(this,arguments)}}()},{key:'processHook',value:function(){var e=u(regeneratorRuntime.mark(function e(t,a){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this._validateRawBody(t);case 3:return e.next=5,this._verifyHook(t,a);case 5:return r=e.sent,e.next=8,this.addToQueue(r);case 8:return e.abrupt('return',Promise.resolve(r));case 11:return e.prev=11,e.t0=e['catch'](0),e.abrupt('return',Promise.reject(e.t0));case 14:case'end':return e.stop();}},e,this,[[0,11]])}));return function(){return e.apply(this,arguments)}}()},{key:'_validateRawBody',value:function(){var e=u(regeneratorRuntime.mark(function e(t){var a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,a=JSON.parse(t),e.abrupt('return',Promise.resolve(a));case 5:return e.prev=5,e.t0=e['catch'](0),e.abrupt('return',e.t0);case 8:case'end':return e.stop();}},e,this,[[0,5]])}));return function(){return e.apply(this,arguments)}}()},{key:'addToQueue',value:function(){var e=u(regeneratorRuntime.mark(function e(t){var a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,a={stushInstance:this,stripeEvent:t},this._queue.push(a),e.next=8;break;case 5:return e.prev=5,e.t0=e['catch'](0),e.abrupt('return',Promise.reject(e.t0));case 8:case'end':return e.stop();}},e,this,[[0,5]])}));return function(){return e.apply(this,arguments)}}()},{key:'on',value:function(){var e=u(regeneratorRuntime.mark(function e(t,a){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,this._emitter.on(t,function(){setImmediate(a)}),this._emitter.listeners(t),e.next=8;break;case 5:return e.prev=5,e.t0=e['catch'](0),e.abrupt('return',Promise.reject(e.t0));case 8:case'end':return e.stop();}},e,this,[[0,5]])}));return function(){return e.apply(this,arguments)}}()},{key:'_verifyHook',value:function(){var e=u(regeneratorRuntime.mark(function e(t,a){var r,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=this.fetchWebhookSecret(),e.next=4,this.stripe.webhooks.constructEvent(t,a,r);case 4:return u=e.sent,e.abrupt('return',Promise.resolve(u));case 8:return e.prev=8,e.t0=e['catch'](0),e.abrupt('return',Promise.reject((0,C.default)(null,e.t0)));case 11:case'end':return e.stop();}},e,this,[[0,8]])}));return function(){return e.apply(this,arguments)}}()}]),e}();e.exports={Stush:W,Plan:y.default,Coupon:k.default,Invoice:j.default,Customer:S.default,Subscription:M.default}},function(e){e.exports=require('stripe')},function(e){e.exports=require('memory-cache')},function(e,t,a){'use strict';function r(e){return e&&e.__esModule?e:{default:e}}function u(e,t){if(!(e instanceof t))throw new TypeError('Cannot call a class as a function')}Object.defineProperty(t,'__esModule',{value:!0}),t.default=void 0;var l=a(0),n=r(l),d=a(7),s=r(d),i=a(10),o=r(i),p=a(3),f=r(p),c=a(5),v=r(c),h=a(1),b=r(h),_=a(2),m=r(_),x=function(){function e(e,t){for(var a,r=0;r<t.length;r++)a=t[r],a.enumerable=a.enumerable||!1,a.configurable=!0,'value'in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}return function(t,a,r){return a&&e(t.prototype,a),r&&e(t,r),t}}(),y=a(8),g=r(y),k=a(4),w=r(k),j=g.default.object().keys({secret:g.default.string().token().required(),webhook_secret:g.default.string().token(),subscription_model:g.default.string().valid('single','multiple'),proration:g.default.string().valid('all','none','change_subscription','cancel_subscription'),charge_instantly:g.default.boolean()}),P=g.default.object().keys({id:g.default.string().required(),price:g.default.number().min(0).required(),currency:g.default.string().length(3,'utf8').required(),bill_every:g.default.string().required(),name:g.default.string().required(),metadata:g.default.object(),statement_descriptor:g.default.string()}),S=g.default.object().keys({customer:g.default.alternatives([g.default.object(),g.default.string().token()]).required(),subscription:g.default.object().keys({application_fee_percent:g.default.number().positive().precision(2),billing:g.default.string().valid('charge_automatically','send_invoice').default('charge_automatically'),coupon:g.default.string(),days_until_due:g.default.alternatives().when('billing',{is:'send_invoice',then:g.default.number().min(1).required(),otherwise:g.default.strip()}),plan:g.default.string().required(),plan_quantity:g.default.number().positive(),source:g.default.string().token(),tax_percent:g.default.number().min(0).precision(2),trial_ends:g.default.number().positive(),trial_days:g.default.number().min(0)}).without('trial_ends','trial_days').required()}).required(),I=g.default.object().keys({customer:g.default.string().token().when('refund_value_from',{is:g.default.exist(),then:g.default.required()}),subscription:g.default.string().token().when('customer',{is:!g.default.exist(),then:g.default.required()}),cancel:g.default.string().valid('now','after_billing_cycle').default('now'),refund:g.default.number().positive(),refund_value_from:g.default.number().positive().when('refund',{is:g.default.exist(),then:g.default.strip()})}),M=function(){function e(){u(this,e)}return x(e,[{key:'validateStushOptions',value:function(e){var t=g.default.validate(e,j);if(t.error)throw(0,w.default)(t.error.details)}},{key:'createPlanInput',value:function(e){var t=g.default.validate(e,P,{allowUnknown:!0});if(t.error)throw t.error;return t}},{key:'createSubscriptionInput',value:function(e){var t=g.default.validate(e,S,{allowUnknown:!0});if((0,m.default)(t,'value.customer')){var a=(0,b.default)(t,'value.customer');if('string'==typeof a)(0,v.default)(t,'value.customer',{id:a});else{var r=['email','source','default_source','account_balance','business_vat_id','coupon','description','metadata'],u=(0,f.default)(a,(0,o.default)((0,s.default)(a,r)));(0,v.default)(t,'value.customer.metadata',{}),(0,n.default)((0,b.default)(t,'value.customer.metadata'),u),(0,v.default)(t,'value.customer',deleteProperties((0,b.default)(t,'value.customer'),(0,o.default)((0,s.default)((0,b.default)(t,'value.customer'),r))))}}return t}},{key:'cancelSubscriptionInput',value:function(e){var t=g.default.validate(e,I);if(t.error)throw t.error;return t}}]),e}();t.default=M,e.exports=M},function(e,t,a){'use strict';function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,'__esModule',{value:!0}),t.formatPlanData=t.validator=void 0;var u=a(7),l=r(u),n=a(10),d=r(n),s=a(28),i=r(s),o=a(29),p=r(o),f=a(17),c=r(f),v=a(30),h=r(v),b=a(2),_=r(b),m=a(1),x=r(m),y=a(3),g=r(y),k=a(5),w=r(k),j=a(8),P=r(j),S=a(4),I=r(S),M=P.default.object().keys({id:P.default.string().required(),object:P.default.string().valid('plan'),amount:P.default.number().min(0).required(),currency:P.default.string().length(3,'utf8').required(),interval:P.default.string().valid('day','week','month','year').required(),interval_count:P.default.number(),livemode:P.default.boolean(),metadata:P.default.object(),name:P.default.string().required(),statement_descriptor:P.default.string()}),q=t.validator=function(e){var t=1<arguments.length&&arguments[1]!==void 0&&arguments[1],a={};t&&(0,w.default)(a,'allowUnknown',!0);var r=P.default.validate(e,M,a);if(r.error)throw r.error;if(!t){(0,w.default)(r,'value',stripEmptyObjects((0,g.default)(e,['metadata','name','statement_descriptor'])))}return r},C=t.formatPlanData=function(e){if((0,x.default)(e,'price',null)&&(0,w.default)(e,'amount',(0,x.default)(e,'price')),(0,_.default)(e,'bill_every')){var t=(0,x.default)(e,'bill_every'),a=(0,h.default)((0,x.default)(e,'bill_every'),' ',2);if(1<a.length&&(P.default.attempt((0,c.default)(a),P.default.number()),1<(0,c.default)(a)&&(0,w.default)(e,'interval_count',(0,p.default)((0,c.default)(a))),t=(0,i.default)(a)),['day','days','daily','everyday','day-to-day'].includes(t))t='day';else if(['week','weeks','weekly'].includes(t))t='week';else if(['month','months','monthly'].includes(t))t='month';else if(['year','yearly'].includes(t))t='year';else throw(0,I.default)('Unable to parse "bill_every" value.');(0,w.default)(e,'interval',t)}var r=['id','name','object','amount','created','currency','livemode','metadata','interval','interval_count','trial_period_days','statement_descriptor'],u=(0,g.default)(e,(0,d.default)((0,l.default)(e,r)));return(0,w.default)(e,'metadata',u),deleteProperties(e,(0,d.default)((0,l.default)(e,r))),e};t.default=M},function(e){e.exports=require('lodash/last')},function(e){e.exports=require('lodash/parseInt')},function(e){e.exports=require('lodash/split')},function(e,t,a){'use strict';function r(e){return e&&e.__esModule?e:{default:e}}function u(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,a){function r(u,l){try{var n=t[u](l),d=n.value}catch(e){return void a(e)}return n.done?void e(d):Promise.resolve(d).then(function(e){r('next',e)},function(e){r('throw',e)})}return r('next')})}}function l(e,t){if(!(e instanceof t))throw new TypeError('Cannot call a class as a function')}Object.defineProperty(t,'__esModule',{value:!0}),t.default=void 0;var n=a(1),d=r(n),s=a(0),i=r(s),o=a(6),p=r(o),f=function(){function e(e,t){for(var a,r=0;r<t.length;r++)a=t[r],a.enumerable=a.enumerable||!1,a.configurable=!0,'value'in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}return function(t,a,r){return a&&e(t.prototype,a),r&&e(t,r),t}}(),c=function(){function e(t,a){l(this,e),this.data={},this._stush={},this._stush=t,this.set(a)}return f(e,[{key:'set',value:function(e){var t=(0,p.default)(this.data);(0,i.default)(t,e),this.data=t}},{key:'toJson',value:function(){return JSON.parse(JSON.stringify((0,d.default)(this,'data')))}}],[{key:'fetchAll',value:function(){var t=u(regeneratorRuntime.mark(function t(a){var r,u,l=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,r=[],t.next=4,a.stripe.coupons.list(l);case 4:return u=t.sent,u.data.forEach(function(t){r.push(new e(a,t))}),t.abrupt('return',Promise.resolve(r));case 9:return t.prev=9,t.t0=t['catch'](0),t.abrupt('return',Promise.reject(t.t0));case 12:case'end':return t.stop();}},t,this,[[0,9]])}));return function(){return t.apply(this,arguments)}}()}]),e}();t.default=c},function(e,t,a){'use strict';function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,'__esModule',{value:!0}),t.sanitizePopulateWithUpcoming=t.validator=void 0;var u=a(7),l=r(u),n=a(0),d=r(n),s=a(2),i=r(s),o=a(3),p=r(o),f=a(5),c=r(f),v=a(8),h=r(v),b=h.default.object().keys({application_fee:h.default.number().positive().allow(null),closed:h.default.boolean(),description:h.default.string().allow(null),forgiven:h.default.boolean(),metadata:h.default.object().allow(null),paid:h.default.boolean(),statement_descriptor:h.default.string().allow(null),tax_percent:h.default.number().min(0).precision(2).allow(null)}),_=t.validator=function(e){var t=1<arguments.length&&arguments[1]!==void 0&&arguments[1],a={};t&&(0,c.default)(a,'allowUnknown',!0);var r=h.default.validate(e,b,a);if(r.error)throw r.error;if(!t){(0,c.default)(r,'value',stripEmptyObjects((0,p.default)(e,['application_fee','closed','description','forgiven','metadata','paid','statement_descriptor','tax_percent'])))}return r},m=t.sanitizePopulateWithUpcoming=function(e){var t=[],a={};return(0,i.default)(e,'customer')&&t.push('customer'),(0,i.default)(e,'subscription')&&t.push('subscription'),(0,d.default)(a,(0,l.default)(e,t)),a};t.default=b},function(e){e.exports=require('lodash/startsWith')},function(e,t,a){'use strict';function r(e){return e&&e.__esModule?e:{default:e}}function u(e,t){if(!(e instanceof t))throw new TypeError('Cannot call a class as a function')}Object.defineProperty(t,'__esModule',{value:!0}),t.default=void 0;var l=a(1),n=r(l),d=a(0),s=r(d),i=a(6),o=r(i),p=function(){function e(e,t){for(var a,r=0;r<t.length;r++)a=t[r],a.enumerable=a.enumerable||!1,a.configurable=!0,'value'in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}return function(t,a,r){return a&&e(t.prototype,a),r&&e(t,r),t}}(),f=a(4),c=r(f),v=function(){function e(t,a){u(this,e),this.data={},this._stush={},this._stush=t,this.set(a)}return p(e,[{key:'set',value:function(e){var t=(0,o.default)(this.data);(0,s.default)(t,e),this.data=t}},{key:'toJson',value:function(){return JSON.parse(JSON.stringify((0,n.default)(this,'data')))}}]),e}();t.default=v},function(e,t,a){'use strict';function r(e){return e&&e.__esModule?e:{default:e}}function u(e,t){if(!(e instanceof t))throw new TypeError('Cannot call a class as a function')}Object.defineProperty(t,'__esModule',{value:!0}),t.default=void 0;var l=a(3),n=r(l),d=a(0),s=r(d),i=a(6),o=r(i),p=function(){function e(e,t){for(var a,r=0;r<t.length;r++)a=t[r],a.enumerable=a.enumerable||!1,a.configurable=!0,'value'in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}return function(t,a,r){return a&&e(t.prototype,a),r&&e(t,r),t}}(),f=function(){function e(t){var a=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};u(this,e),this.data={},this._stush={},this._stush=t,this.set(a)}return p(e,[{key:'set',value:function(e){var t=(0,o.default)(this.data);(0,s.default)(t,e),this.data=t}},{key:'toJson',value:function(){return JSON.parse(JSON.stringify((0,n.default)(this,['data'])))}}]),e}();t.default=f},function(e,t,a){'use strict';function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,'__esModule',{value:!0}),t.changeSubscriptionValidator=t.formatChangeSubscriptionInput=t.stripConfigOptions=t.formatSubscriptionData=t.validator=t.changeSubscriptionSchema=void 0;var u=a(19),l=r(u),n=a(0),d=r(n),s=a(12),i=r(s),o=a(7),p=r(o),f=a(10),c=r(f),v=a(16),h=r(v),b=a(37),_=r(b),m=a(3),x=r(m),y=a(5),g=r(y),k=a(2),w=r(k),j=a(9),P=r(j),S=a(1),I=r(S),M=a(8),q=r(M),C=['id','object','application_fee_percent','billing','cancel_at_period_end','canceled_at','created','current_period_end','current_period_start','customer','discount','ended_at','livemode','quantity','start','status','trial_end','trial_start','coupon','days_until_due','items','source','metadata','prorate','proration_date','tax_percent','trial_period_days','trial_ends'],A=['cancellation_proration','prorate_from','cancel','refund','refund_value_from'],J=q.default.object().keys({id:q.default.string().token(),customer:q.default.string().token(),application_fee_percent:q.default.number().positive().precision(2).allow(null),billing:q.default.string().valid('charge_automatically','send_invoice').default('charge_automatically'),coupon:q.default.string(),days_until_due:q.default.number().when('billing',{is:'send_invoice',then:q.default.number().min(1).required()}).allow(null),items:q.default.alternatives([q.default.array().items(q.default.object().keys({id:q.default.string().token(),deleted:q.default.boolean(),metadata:q.default.object(),plan:q.default.string().when('id',{is:!q.default.exist(),then:q.default.required()}),quantity:q.default.number().min(0)})),q.default.object()]),metadata:q.default.object(),prorate:q.default.boolean(),proration_date:q.default.number().positive(),source:q.default.string().token(),tax_percent:q.default.number().min(0).precision(2).allow(null),trial_ends:q.default.number().positive(),trial_period_days:q.default.number().positive()}),D=t.changeSubscriptionSchema=q.default.object().keys({subscription:q.default.alternatives([q.default.string().token(),q.default.object()]),plan_to_change:q.default.string(),plan:q.default.string().required(),prorate_from:q.default.number().positive()}),U=t.validator=function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1],a=q.default.validate(e,J,{allowUnknown:!0});if(a.error)throw a.error;if('send_invoice'!==(0,I.default)(a,'value.billing',!1)&&(0,P.default)(a,'value.days_until_due'),!t){var r=['application_fee_percent','billing','coupon','days_until_due','items','source','metadata','prorate','proration_date','tax_percent','trial_ends'];(0,w.default)(e,'id')||r.push('trial_period_days'),(0,g.default)(a,'value',stripEmptyObjects((0,x.default)(e,r)))}return a},O=t.formatSubscriptionData=function(e){var t=(0,_.default)(C,A);(0,w.default)(e,'plan')&&!(0,h.default)((0,I.default)(e,'plan'))?t.push('plan'):!(0,w.default)(e,'items')&&((0,g.default)(e,'items',[]),e.items.push({plan:(0,I.default)(e,'plan'),quantity:(0,I.default)(e,'plan_quantity',1)})),0<(0,I.default)(e,'trial_days',0)&&(0,g.default)(e,'trial_period_days',(0,I.default)(e,'trial_days')),(0,P.default)(e,'trial_days');var a=(0,c.default)((0,p.default)(e,t));(0,h.default)((0,I.default)(e,'plan'))&&(0,i.default)(a,function(e){return'plan'===e});var r=(0,x.default)(e,a);return(0,w.default)(e,'metadata')||(0,g.default)(e,'metadata',{}),(0,d.default)((0,I.default)(e,'metadata'),r),deleteProperties(e,(0,c.default)((0,p.default)(e,t))),e},E=t.stripConfigOptions=function(e){return deleteProperties(e,A)},V=t.formatChangeSubscriptionInput=function(e,t){var a={},r=t.fetchSubscriptionItem();return(0,w.default)(e,'data.items')&&(0,l.default)((0,I.default)(e,'data.items'))||(0,g.default)(a,'value.items',[{id:r.id,plan:(0,I.default)(e,'plan')}]),(0,g.default)(a,'value.plan_to_change',(0,I.default)(r,'plan.id')),e},W=t.changeSubscriptionValidator=function(e){var t=q.default.validate(e,D);if(t.error)throw t.error;return t};t.default=J},function(e){e.exports=require('lodash/concat')},function(e,t,a){'use strict';function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,'__esModule',{value:!0}),t.makeUtilsGlobal=void 0;var u=a(39),l=r(u),n=a(12),d=r(n),s=a(40),i=r(s),o=a(9),p=r(o),f=function(){function e(e,t){var a,r=[],u=!0,l=!1;try{for(var n,d=e[Symbol.iterator]();!(u=(n=d.next()).done)&&(r.push(n.value),!(t&&r.length===t));u=!0);}catch(e){l=!0,a=e}finally{try{!u&&d['return']&&d['return']()}finally{if(l)throw a}}return r}return function(t,a){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,a);throw new TypeError('Invalid attempt to destructure non-iterable instance')}}(),c='function'==typeof Symbol&&'symbol'==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&'function'==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?'symbol':typeof e},v=a(41),h=r(v),b=a(4),_=r(b),m=function(){for(var e=arguments.length,t=Array(e),a=0;a<e;a++)t[a]=arguments[a]},x=function(e,t){return t.forEach(function(t){(0,p.default)(e,t)}),e},y=function(e){if('object'!==('undefined'==typeof e?'undefined':c(e)))throw{isJoi:!0,details:[{message:'Invalid argument. Argument of type \'object\' expected.',code:500}]};var t=(0,i.default)(e);return(0,d.default)(t,function(e){var t=f(e,2),a=t[0],r=t[1];return'object'===('undefined'==typeof r?'undefined':c(r))&&g(r)}),(0,l.default)(t)},g=function(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0},k=function(e){return new Promise.resolve(setTimeout(e))},w=t.makeUtilsGlobal=function(){global.debug=m,global.timeout=k,global.deleteProperties=x,global.stripEmptyObjects=y}},function(e){e.exports=require('lodash/fromPairs')},function(e){e.exports=require('lodash/toPairs')},function(e){e.exports=require('util')},function(e){e.exports=require('better-queue')},function(e,t,a){'use strict';function r(e,t){if(!(e instanceof t))throw new TypeError('Cannot call a class as a function')}Object.defineProperty(t,'__esModule',{value:!0}),t.default=void 0;var u=a(1),l=function(e){return e&&e.__esModule?e:{default:e}}(u),n=function(){function e(e,t){for(var a,r=0;r<t.length;r++)a=t[r],a.enumerable=a.enumerable||!1,a.configurable=!0,'value'in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}return function(t,a,r){return a&&e(t.prototype,a),r&&e(t,r),t}}(),d=function(){function e(){r(this,e)}return n(e,null,[{key:'process',value:function(e,t){try{console.log('\n\n\n\n\nEMITTING EVENT!\n\n\n\n\n'),e.stushInstance._emitter.emit((0,l.default)(e,'stripeEvent.type','unidentified_event')),t(null,{type:(0,l.default)(e,'stripeEvent.type','unidentified_event'),event:(0,l.default)(e,'stripeEvent',{})})}catch(e){t(e,null)}}}]),e}();t.default=d},function(e){e.exports=require('events')}])});